# PinAI Subnet - Docker Compose Configuration
# Single machine deployment with all services

version: '3.8'

services:
  # ============================================
  # Registry Service
  # ============================================
  registry:
    build: .
    container_name: pinai-registry
    hostname: registry
    command: /app/bin/registry -grpc :8091 -http :8101
    ports:
      - "8091:8091"  # gRPC
      - "8101:8101"  # HTTP
    volumes:
      - ./data/registry:/app/data
      - ./subnet-logs:/app/logs
    networks:
      - subnet-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8101/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Matcher Service
  # ============================================
  matcher:
    build: .
    container_name: pinai-matcher
    hostname: matcher
    command: /app/bin/matcher -config /app/config/matcher.yaml
    ports:
      - "8090:8090"  # gRPC
      - "8092:8091"  # HTTP (mapped to 8092 to avoid conflict)
    volumes:
      - ./data/matcher:/app/data
      - ./subnet-logs:/app/logs
      - ./config/matcher-docker.yaml:/app/config/matcher.yaml:ro
    environment:
      - SUBNET_ID=${SUBNET_ID}
      - ROOTLAYER_GRPC=${ROOTLAYER_GRPC}
      - ROOTLAYER_HTTP=${ROOTLAYER_HTTP}
      - TEST_PRIVATE_KEY=${TEST_PRIVATE_KEY}
      - ENABLE_CHAIN_SUBMIT=${ENABLE_CHAIN_SUBMIT:-true}
      - CHAIN_RPC_URL=${CHAIN_RPC_URL:-https://sepolia.base.org}
      - CHAIN_NETWORK=${CHAIN_NETWORK:-base_sepolia}
      - INTENT_MANAGER_ADDR=${INTENT_MANAGER_ADDR}
    networks:
      - subnet-network
    depends_on:
      registry:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ============================================
  # Validator Service
  # ============================================
  validator:
    build: .
    container_name: pinai-validator
    hostname: validator
    command: >
      /app/bin/validator
      -id validator-1
      -grpc 9090
      -subnet-id ${SUBNET_ID}
      -key ${VALIDATOR_KEYS}
      -storage /app/data/storage
      -rootlayer-endpoint ${ROOTLAYER_GRPC}
      -chain-rpc-url ${CHAIN_RPC_URL:-https://sepolia.base.org}
      -chain-network ${CHAIN_NETWORK:-base_sepolia}
      -intent-manager-addr ${INTENT_MANAGER_ADDR}
      -enable-chain-submit
      -enable-rootlayer
      -validators 1
      -threshold-num 1
      -threshold-denom 1
      -validator-pubkeys validator-1:${VALIDATOR_PUBKEYS}
      -raft-enable
      -raft-bootstrap
      -raft-bind 0.0.0.0:7400
      -raft-data-dir /app/data/raft
      -raft-peers validator-1:validator:7400
      -gossip-enable
      -gossip-bind 0.0.0.0
      -gossip-port 7950
      -gossip-seeds validator:7950
      -validator-endpoints validator-1:validator:9090
    ports:
      - "9090:9090"  # gRPC
      - "7400:7400"  # Raft
      - "7950:7950"  # Gossip
    volumes:
      - ./data/validator:/app/data
      - ./subnet-logs:/app/logs
    environment:
      - SUBNET_ID=${SUBNET_ID}
      - ROOTLAYER_GRPC=${ROOTLAYER_GRPC}
      - ROOTLAYER_HTTP=${ROOTLAYER_HTTP}
      - VALIDATOR_KEYS=${VALIDATOR_KEYS}
      - VALIDATOR_PUBKEYS=${VALIDATOR_PUBKEYS}
      - CHAIN_RPC_URL=${CHAIN_RPC_URL:-https://sepolia.base.org}
      - CHAIN_NETWORK=${CHAIN_NETWORK:-base_sepolia}
      - INTENT_MANAGER_ADDR=${INTENT_MANAGER_ADDR}
    networks:
      - subnet-network
    depends_on:
      registry:
        condition: service_healthy
      matcher:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z localhost 9090 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ============================================
  # Simple Agent (Optional)
  # ============================================
  agent:
    build: .
    container_name: pinai-agent
    hostname: agent
    command: >
      /app/bin/simple-agent
      -matcher matcher:8090
      -validator validator:9090
      -subnet-id ${SUBNET_ID}
      -id test-agent-1
      -name TestAgent1
    volumes:
      - ./subnet-logs:/app/logs
    environment:
      - SUBNET_ID=${SUBNET_ID}
    networks:
      - subnet-network
    depends_on:
      matcher:
        condition: service_healthy
      validator:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - with-agent  # Optional: start with --profile with-agent

# ============================================
# Networks
# ============================================
networks:
  subnet-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================
# Volumes (optional, for persistence)
# ============================================
volumes:
  registry-data:
  matcher-data:
  validator-data:

